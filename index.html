<!DOCTYPE html>
<html lang="es" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>Ministerio de Jóvenes | Conectando Generaciones</title>
    <!-- Metadatos para Mobile Web App -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="MJS Jóvenes">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            transition: background-color 0.3s ease, color 0.3s ease;
            overflow-x: hidden;
            width: 100%;
        }
        .lesson-card:hover { transform: translateY(-5px); }
        #modal-overlay { transition: opacity 0.3s ease; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .animate-pulse-soft { animation: pulse-soft 2s infinite; }
    </style>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        youthPrimary: '#6366f1',
                        youthSecondary: '#f43f5e',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-gray-900 dark:text-gray-100 min-h-screen font-sans antialiased">

    <!-- Navegación -->
    <nav class="fixed w-full z-50 bg-white/90 dark:bg-gray-800/90 backdrop-blur-md border-b border-gray-200 dark:border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16 items-center">
                <div class="flex items-center gap-2">
                    <div class="bg-youthPrimary p-2 rounded-lg">
                        <i data-lucide="zap" class="text-white w-5 h-5 sm:w-6 sm:h-6"></i>
                    </div>
                    <span class="text-lg sm:text-xl font-bold tracking-tighter uppercase italic truncate">MJS | Jóvenes</span>
                </div>
                
                <div class="hidden md:flex space-x-8 font-medium">
                    <a href="#inicio" class="hover:text-youthPrimary transition">Inicio</a>
                    <a href="#lecciones" class="hover:text-youthPrimary transition">Lecciones</a>
                    <a href="#eventos" class="hover:text-youthPrimary transition">Eventos</a>
                </div>

                <div class="flex items-center gap-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700 transition">
                        <i id="theme-icon" data-lucide="moon" class="w-5 h-5"></i>
                    </button>
                    <button class="md:hidden p-2" onclick="toggleMobileMenu()">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header id="inicio" class="pt-32 pb-12 px-4 text-center">
        <div class="max-w-5xl mx-auto">
            <h1 class="text-4xl sm:text-7xl font-black mb-6 uppercase leading-tight tracking-tighter">
                Más que religión,<br><span class="text-youthPrimary">relación.</span>
            </h1>
            <div class="bg-white dark:bg-gray-800 p-8 rounded-3xl shadow-xl border border-gray-100 dark:border-gray-700 max-w-2xl mx-auto">
                <div class="flex items-center justify-center gap-2 text-youthSecondary mb-4">
                    <i data-lucide="book-open" class="w-5 h-5"></i>
                    <span class="font-bold uppercase tracking-widest text-xs">Versículo del Día</span>
                </div>
                <p id="verse-text" class="text-lg font-medium italic mb-4">"Cargando palabra..."</p>
                <p id="verse-ref" class="font-bold text-youthPrimary">--:--</p>
            </div>
        </div>
    </header>

    <!-- Eventos -->
    <section id="eventos" class="py-20 bg-gray-100 dark:bg-gray-800/30">
        <div class="max-w-4xl mx-auto px-4">
            <h2 class="text-3xl font-black text-center mb-12 uppercase italic">Próximos Encuentros</h2>
            
            <div class="space-y-6">
                <!-- Evento Jueves -->
                <div class="flex flex-col sm:flex-row items-center gap-6 p-8 bg-white dark:bg-gray-800 rounded-3xl shadow-lg border-l-8 border-youthPrimary">
                    <div class="text-center bg-youthPrimary/10 p-4 rounded-2xl min-w-[120px]">
                        <span class="block text-xs font-bold text-youthPrimary uppercase">Cada</span>
                        <span class="block text-2xl font-black text-youthPrimary uppercase">Jueves</span>
                    </div>
                    <div class="flex-grow text-center sm:text-left">
                        <h3 class="text-xl font-black uppercase italic">Reunión Online</h3>
                        <p class="text-gray-500 text-sm">Vía Zoom / YouTube • 9:00 PM</p>
                    </div>
                    <div class="flex flex-col gap-2 w-full sm:w-auto">
                        <button id="btn-jueves" onclick="toggleEventReminder('jueves')" class="w-full sm:w-auto bg-youthPrimary text-white px-8 py-3 rounded-2xl font-black uppercase text-xs tracking-widest hover:scale-105 transition flex items-center justify-center gap-2">
                            <i data-lucide="bell" class="w-4 h-4"></i> Recuérdame
                        </button>
                        <button id="cancel-jueves" onclick="toggleEventReminder('jueves')" class="hidden text-[10px] font-bold text-red-500 uppercase tracking-tighter hover:underline">
                            Desactivar recordatorio
                        </button>
                    </div>
                </div>
            </div>

            <!-- Botón de Prueba -->
            <div class="mt-16 text-center">
                <button id="test-notif-btn" onclick="triggerDelayedNotification()" class="group relative inline-flex items-center gap-2 text-gray-400 hover:text-youthPrimary transition text-xs font-bold uppercase tracking-widest border border-dashed border-gray-300 dark:border-gray-700 px-6 py-3 rounded-full overflow-hidden">
                    <span id="test-btn-content" class="flex items-center gap-2">
                        <i data-lucide="terminal" class="w-3 h-3"></i> Notificación de Prueba (10s)
                    </span>
                    <div id="test-progress-bar" class="absolute bottom-0 left-0 h-1 bg-youthPrimary w-0 transition-all duration-[30000ms] ease-linear"></div>
                </button>
            </div>
        </div>
    </section>

    <!-- Lecciones -->
    <section id="lecciones" class="py-20">
        <div class="max-w-7xl mx-auto px-4">
            <h2 class="text-3xl font-black mb-10 text-center uppercase">Enseñanzas</h2>
            <div id="lessons-grid" class="grid grid-cols-1 md:grid-cols-3 gap-8"></div>
        </div>
    </section>

    <footer class="py-10 text-center border-t border-gray-200 dark:border-gray-800">
        <p class="text-xl font-black italic uppercase">MJS | Jóvenes</p>
    </footer>

    <script>
        // Los navegadores modernos en entornos de desarrollo restrictivos no permiten registrar Blobs como SW.
        // Utilizaremos la API de Notificaciones estándar que es altamente compatible con móviles si la página se mantiene abierta en segundo plano.

        const lessonsData = [
            { id: 1, title: "Identidad Digital", category: "Vida", content: "¿Quién eres cuando nadie te ve? Tu valor no está en los likes, sino en el amor de Dios." },
            { id: 2, title: "Dudas y Fe", category: "Fe", content: "Las dudas no son el fin de la fe, son el comienzo de una búsqueda más sincera." },
            { id: 3, title: "Relaciones Reales", category: "Amor", content: "Cómo construir amistades y noviazgos que honren a Dios y cuiden tu corazón." }
        ];

        let activeTimeouts = { jueves: [] };
        let isTesting = false;

        function getReminderState(eventId) {
            return localStorage.getItem(`reminder_${eventId}`) === 'true';
        }

        function setReminderState(eventId, isActive) {
            localStorage.setItem(`reminder_${eventId}`, isActive);
        }

        async function toggleEventReminder(eventId) {
            const currentState = getReminderState(eventId);
            
            if (!currentState) {
                if (!("Notification" in window)) {
                    alert("Tu navegador no soporta notificaciones.");
                    return;
                }

                const permission = await Notification.requestPermission();
                if (permission === "granted") {
                    setReminderState(eventId, true);
                    updateButtonUI(eventId, true);
                    scheduleNotifications(eventId);
                    
                    new Notification("¡Recordatorio Activado!", { 
                        body: "Te avisaremos 15, 10, y 5 minutos antes de la reunión.",
                        icon: "https://cdn-icons-png.flaticon.com/512/3652/3652191.png"
                    });
                } else {
                    alert("Debes permitir las notificaciones en tu navegador/móvil para usar esta función.");
                }
            } else {
                setReminderState(eventId, false);
                updateButtonUI(eventId, false);
                cancelScheduledNotifications(eventId);
            }
        }

        function updateButtonUI(eventId, isActive) {
            const btn = document.getElementById(`btn-${eventId}`);
            const cancel = document.getElementById(`cancel-${eventId}`);
            if (!btn) return;
            
            if (isActive) {
                btn.innerHTML = `<i data-lucide="check" class="w-4 h-4"></i> Programado`;
                btn.classList.replace('bg-youthPrimary', 'bg-green-500');
                btn.classList.add('pointer-events-none');
                cancel.classList.remove('hidden');
            } else {
                btn.innerHTML = `<i data-lucide="bell" class="w-4 h-4"></i> Recuérdame`;
                btn.classList.replace('bg-green-500', 'bg-youthPrimary');
                btn.classList.remove('pointer-events-none');
                cancel.classList.add('hidden');
            }
            lucide.createIcons();
        }

        function scheduleNotifications(eventId) {
            cancelScheduledNotifications(eventId);
            
            const now = new Date();
            let eventTime = new Date();
            
            if (eventId === 'jueves') {
                // Calcular próximo jueves
                const dayOfWeek = 4; // Jueves
                const distance = (dayOfWeek + 7 - now.getDay()) % 7;
                eventTime.setDate(now.getDate() + distance);
                eventTime.setHours(21, 0, 0, 0);
                
                // Si ya pasó hoy, programar para el siguiente jueves
                if (eventTime <= now) eventTime.setDate(eventTime.getDate() + 7);
            }

            const alerts = [
                { offset: 15, msg: "¡15 minutos para empezar! Prepárate para la reunión." },
                { offset: 10, msg: "¡10 minutos para empezar! Prepárate para la reunión." },
                { offset: 5, msg: "¡5 minutos para empezar! Prepárate para la reunión." },
                { offset: 0, msg: "¡Estamos EN VIVO! Únete ahora a la comunidad." }
            ];

            alerts.forEach(alertData => {
                const triggerTime = new Date(eventTime.getTime() - alertData.offset * 60000);
                const delay = triggerTime.getTime() - now.getTime();

                if (delay > 0) {
                    const tid = setTimeout(() => {
                        if (getReminderState(eventId)) {
                            new Notification("MJS | Recordatorio", { 
                                body: alertData.msg,
                                icon: "https://cdn-icons-png.flaticon.com/512/3652/3652191.png"
                            });
                        }
                    }, delay);
                    activeTimeouts[eventId].push(tid);
                }
            });
        }

        function cancelScheduledNotifications(eventId) {
            if (activeTimeouts[eventId]) {
                activeTimeouts[eventId].forEach(clearTimeout);
                activeTimeouts[eventId] = [];
            }
        }

        async function triggerDelayedNotification() {
            if (isTesting) return;
            const permission = await Notification.requestPermission();
            if (permission !== "granted") {
                alert("Activa las notificaciones para probar.");
                return;
            }

            isTesting = true;
            const btn = document.getElementById('test-notif-btn');
            const content = document.getElementById('test-btn-content');
            const progress = document.getElementById('test-progress-bar');
            
            btn.classList.add('pointer-events-none', 'text-youthPrimary');
            progress.style.width = '100%';

            let seconds = 10;
            const msgs = ["Preparando...", "Enviando!"];

            const timer = setInterval(() => {
                seconds--;
                content.innerHTML = `<span class="animate-pulse-soft flex items-center gap-2 italic"><i data-lucide="loader-2" class="w-3 h-3 animate-spin"></i> ${msgs[Math.floor(seconds/8)] || 'Listo'} (${seconds}s)</span>`;
                lucide.createIcons();

                if (seconds <= 0) {
                    clearInterval(timer);
                    new Notification("Prueba de MJS", { 
                        body: "¡Funciona! Así recibirás los avisos en tu móvil o pc.",
                        icon: "https://cdn-icons-png.flaticon.com/512/3652/3652191.png"
                    });
                    resetTestBtn();
                }
            }, 1000);
        }

        function resetTestBtn() {
            isTesting = false;
            const btn = document.getElementById('test-notif-btn');
            const content = document.getElementById('test-btn-content');
            const progress = document.getElementById('test-progress-bar');
            btn.classList.remove('pointer-events-none', 'text-youthPrimary');
            progress.style.transition = 'none';
            progress.style.width = '0';
            setTimeout(() => progress.style.transition = 'all 30s linear', 50);
            content.innerHTML = `<i data-lucide="terminal" class="w-3 h-3"></i> Notificación de Prueba (30s)`;
            lucide.createIcons();
        }

        async function fetchVerse() {
            try {
                const res = await fetch('https://bible-api.com/john+3:16?translation=rva');
                const data = await res.json();
                document.getElementById('verse-text').innerText = `"${data.text.trim()}"`;
                document.getElementById('verse-ref').innerText = data.reference;
            } catch (e) {
                document.getElementById('verse-text').innerText = '"No temas, porque yo estoy contigo."';
                document.getElementById('verse-ref').innerText = "Isaías 41:10";
            }
        }

        function renderLessons() {
            const grid = document.getElementById('lessons-grid');
            if(!grid) return;
            lessonsData.forEach(l => {
                const div = document.createElement('div');
                div.className = "bg-white dark:bg-gray-800 p-6 rounded-3xl shadow-md border border-gray-100 dark:border-gray-700 hover:shadow-xl transition duration-300";
                div.innerHTML = `
                    <span class="text-[10px] font-black uppercase text-youthPrimary bg-youthPrimary/10 px-2 py-1 rounded-full">${l.category}</span>
                    <h3 class="font-bold my-2 text-lg">${l.title}</h3>
                    <p class="text-sm text-gray-500 dark:text-gray-400 line-clamp-2">${l.content}</p>
                `;
                grid.appendChild(div);
            });
        }

        window.onload = () => {
            fetchVerse();
            renderLessons();
            lucide.createIcons();
            
            // Restaurar estados persistentes
            const events = ['jueves'];
            events.forEach(ev => {
                if (getReminderState(ev)) {
                    updateButtonUI(ev, true);
                    scheduleNotifications(ev);
                }
            });

            if (localStorage.getItem('theme') === 'dark') {
                document.documentElement.classList.add('dark');
            }
        };

        document.getElementById('theme-toggle').onclick = () => {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
            lucide.createIcons();
        };

        function toggleMobileMenu() {
            const menu = document.querySelector('.md\\:flex');
            menu.classList.toggle('hidden');
            menu.classList.toggle('flex-col');
            menu.classList.toggle('absolute');
            menu.classList.toggle('top-16');
            menu.classList.toggle('left-0');
            menu.classList.toggle('w-full');
            menu.classList.toggle('bg-white');
            menu.classList.toggle('dark:bg-gray-800');
            menu.classList.toggle('p-6');
            menu.classList.toggle('shadow-xl');
        }
    </script>
</body>
</html>
